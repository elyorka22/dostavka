<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tizimga kirish</title>
    <link rel="stylesheet" href="styles/base.css">
    <link rel="stylesheet" href="styles/layout.css">
    <link rel="stylesheet" href="styles/components.css">
    <link rel="stylesheet" href="styles/admin.css">
</head>
<body class="login-page">
    <div class="login-container">
        <div class="login-card">
            <!-- Переключатель между входом и регистрацией -->
            <div class="auth-tabs">
                <button class="auth-tab active" id="login-tab" onclick="switchToLogin()">Kirish</button>
                <button class="auth-tab" id="register-tab" onclick="switchToRegister()">Ro'yxatdan o'tish</button>
            </div>
            
            <!-- Форма входа -->
            <div class="auth-form" id="login-form-container">
                <h1 class="login-title">Tizimga kirish</h1>
                <p class="login-subtitle">Login va parolni kiriting</p>
                
                <form class="login-form" id="login-form">
                    <div class="form-group">
                        <label for="login-input" class="form-label">Login yoki Email</label>
                        <input 
                            type="text" 
                            id="login-input" 
                            class="form-input" 
                            placeholder="Loginni kiriting" 
                            required
                            autocomplete="username"
                        >
                    </div>

                    <div class="form-group">
                        <label for="password-input" class="form-label">Parol</label>
                        <input 
                            type="password" 
                            id="password-input" 
                            class="form-input" 
                            placeholder="Parolni kiriting" 
                            required
                            autocomplete="current-password"
                        >
                    </div>

                    <div class="form-error" id="login-error"></div>

                    <button type="submit" class="login-btn">Kirish</button>
                </form>
            </div>
            
            <!-- Форма регистрации -->
            <div class="auth-form" id="register-form-container" style="display: none;">
                <h1 class="login-title">Ro'yxatdan o'tish</h1>
                <p class="login-subtitle">Yangi akkaunt yarating</p>
                
                <form class="login-form" id="register-form">
                    <div class="form-group">
                        <label for="register-name" class="form-label">Ism</label>
                        <input 
                            type="text" 
                            id="register-name" 
                            class="form-input" 
                            placeholder="Ismingizni kiriting" 
                            required
                            autocomplete="name"
                        >
                    </div>

                    <div class="form-group">
                        <label for="register-email" class="form-label">Email</label>
                        <input 
                            type="email" 
                            id="register-email" 
                            class="form-input" 
                            placeholder="Email manzilingizni kiriting" 
                            required
                            autocomplete="email"
                        >
                    </div>

                    <div class="form-group">
                        <label for="register-phone" class="form-label">Telefon raqami</label>
                        <input 
                            type="tel" 
                            id="register-phone" 
                            class="form-input" 
                            placeholder="+998901234567" 
                            autocomplete="tel"
                        >
                    </div>

                    <div class="form-group">
                        <label for="register-password" class="form-label">Parol</label>
                        <input 
                            type="password" 
                            id="register-password" 
                            class="form-input" 
                            placeholder="Parolni kiriting (min. 6 belgi)" 
                            required
                            autocomplete="new-password"
                            minlength="6"
                        >
                    </div>

                    <div class="form-group">
                        <label for="register-password-confirm" class="form-label">Parolni tasdiqlash</label>
                        <input 
                            type="password" 
                            id="register-password-confirm" 
                            class="form-input" 
                            placeholder="Parolni qayta kiriting" 
                            required
                            autocomplete="new-password"
                            minlength="6"
                        >
                    </div>

                    <div class="form-error" id="register-error"></div>

                    <button type="submit" class="login-btn">Ro'yxatdan o'tish</button>
                </form>
            </div>

            <div class="login-info">
                <p class="login-info__title">Test akkauntlar:</p>
                <ul class="login-info__list">
                    <li><strong>admin</strong> / admin123 - Super-admin</li>
                    <li><strong>manager</strong> / manager123 - Menejer</li>
                    <li><strong>picker</strong> / picker123 - Yig'uvchi</li>
                    <li><strong>courier</strong> / courier123 - Kuryer</li>
                    <li><strong>user</strong> / user123 - Oddiy foydalanuvchi</li>
                </ul>
            </div>

            <div class="login-footer">
                <a href="index.html" class="login-link">← Saytga qaytish</a>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>
    
    <!-- Firebase Config -->
    <script src="js/firebase-config.js"></script>
    
    <!-- API Configuration -->
    <script src="js/config.js"></script>
    
    <!-- API Module -->
    <script src="js/api.js"></script>
    
    <!-- Application Scripts -->
    <!-- API Configuration -->
    <script>
        // Установка переменных для Railway API
        (function() {
            var isProduction = window.location && 
                              window.location.hostname !== 'localhost' && 
                              window.location.hostname !== '127.0.0.1';
            
            if (isProduction) {
                // В продакшене используем Railway API
                // Установите ваш Railway URL в переменных окружения Vercel
                // Или установите здесь напрямую:
                // window.RAILWAY_API_URL = 'https://ваш-railway-url.railway.app';
                window.API_MODE = 'api';
            }
        })();
    </script>
    
    <script src="js/users.js"></script>
    <script src="js/roles.js"></script>
    <script>
        // Инициализация Firebase и загрузка пользователей
        (function() {
            // Проверка, продакшен или локально
            var isProduction = window.location && 
                              window.location.hostname !== 'localhost' && 
                              window.location.hostname !== '127.0.0.1';
            
            // Инициализация Firebase (только если используется Firebase режим)
            if (typeof initFirebase !== 'undefined' && window.API_MODE === 'firebase') {
                document.addEventListener('DOMContentLoaded', function() {
                    if (initFirebase()) {
                        // В продакшене переключить на Firebase режим
                        if (isProduction && typeof setAPIMode !== 'undefined') {
                            try {
                                console.log('Переключение на Firebase режим...');
                                setAPIMode('firebase');
                                console.log('API_MODE установлен в:', typeof API_MODE !== 'undefined' ? API_MODE : 'не определен');
                                
                                // Загрузить пользователей из Firebase
                                if (typeof loadUsersFromFirebase !== 'undefined') {
                                    setTimeout(function() {
                                        loadUsersFromFirebase();
                                    }, 500);
                                } else if (typeof initUsersStorage !== 'undefined') {
                                    setTimeout(function() {
                                        initUsersStorage();
                                    }, 500);
                                }
                            } catch (e) {
                                console.error('Ошибка инициализации Firebase:', e);
                                if (typeof logError !== 'undefined') {
                                    logError('Ошибка инициализации Firebase', e);
                                }
                            }
                        }
                    }
                });
            } else if (!isProduction) {
                // Локально загрузить пользователей
                console.log('Локальный режим, загрузка пользователей из localStorage...');
                if (typeof initUsersStorage !== 'undefined') {
                    initUsersStorage();
                }
            }
        })();
        
        // Инициализация обработчиков форм после загрузки DOM
        function initForms() {
            // Обработка формы входа
            var loginForm = document.getElementById('login-form');
            var loginError = document.getElementById('login-error');
            if (!loginForm || !loginError) {
                // Элементы еще не загружены, попробовать позже
                setTimeout(initForms, 100);
                return;
            }
            var loginBtn = loginForm.querySelector('.login-btn');
            var originalBtnText = loginBtn.textContent;

            // Функция ожидания загрузки пользователей
            function waitForUsers(callback, maxAttempts) {
            maxAttempts = maxAttempts || 20; // Максимум 20 попыток (10 секунд)
            var attempts = 0;
            
            function checkUsers() {
                attempts++;
                
                // Проверить, загружены ли пользователи
                if (typeof usersStorage !== 'undefined' && usersStorage.users.length > 0) {
                    callback(true);
                    return;
                }
                
                // Если не загружены и есть попытки
                if (attempts < maxAttempts) {
                    // Попробовать загрузить пользователей
                    if (typeof loadUsersFromFirebase !== 'undefined' && typeof API_MODE !== 'undefined' && API_MODE === 'firebase') {
                        loadUsersFromFirebase();
                    } else if (typeof initUsersStorage !== 'undefined') {
                        initUsersStorage();
                    }
                    
                    // Подождать и проверить снова
                    setTimeout(checkUsers, 500);
                } else {
                    // Превышено количество попыток
                    callback(false);
                }
            }
            
                checkUsers();
            }
            
            // Функция попытки входа
            function tryLogin(loginValue, password) {
            if (typeof login === 'undefined') {
                loginError.textContent = 'Xatolik: login funksiyasi topilmadi';
                loginError.style.display = 'block';
                loginBtn.disabled = false;
                loginBtn.textContent = originalBtnText;
                return;
            }
            
            var user = login(loginValue, password);

            if (user) {
                // Получить страницу для роли пользователя
                if (typeof getRolePage !== 'undefined') {
                    var rolePage = getRolePage(user.role);
                    window.location.href = rolePage;
                } else {
                    loginError.textContent = 'Xatolik: getRolePage funksiyasi topilmadi';
                    loginError.style.display = 'block';
                    loginBtn.disabled = false;
                    loginBtn.textContent = originalBtnText;
                }
            } else {
                loginError.textContent = 'Noto\'g\'ri login yoki parol';
                loginError.style.display = 'block';
                loginBtn.disabled = false;
                    loginBtn.textContent = originalBtnText;
                }
            }

            loginForm.addEventListener('submit', function(event) {
            event.preventDefault();

            var loginValue = document.getElementById('login-input').value.trim();
            var password = document.getElementById('password-input').value;

            // Валидация
            if (!loginValue || !password) {
                loginError.textContent = 'Iltimos, login va parolni kiriting';
                loginError.style.display = 'block';
                return;
            }

            loginError.textContent = '';
            loginError.style.display = 'none';
            
            // Показать индикатор загрузки
            loginBtn.disabled = true;
            loginBtn.textContent = 'Yuklanmoqda...';

            // Проверить, загружены ли пользователи
            if (typeof usersStorage !== 'undefined' && usersStorage.users.length > 0) {
                // Пользователи уже загружены, можно входить
                tryLogin(loginValue, password);
            } else {
                // Ждать загрузки пользователей
                waitForUsers(function(success) {
                    if (success) {
                        tryLogin(loginValue, password);
                    } else {
                        loginError.textContent = 'Xatolik: foydalanuvchilar yuklanmadi. Iltimos, sahifani yangilang.';
                        loginError.style.display = 'block';
                        loginBtn.disabled = false;
                        loginBtn.textContent = originalBtnText;
                    }
                });
            }
            });
            
            // Функция ожидания загрузки функции register
            function waitForRegister(callback, maxAttempts) {
            maxAttempts = maxAttempts || 20; // Максимум 20 попыток (10 секунд)
            var attempts = 0;
            
            function checkRegister() {
                attempts++;
                
                // Проверить, загружена ли функция register
                if (typeof register !== 'undefined' && typeof window.register !== 'undefined') {
                    callback(true);
                    return;
                }
                
                // Если не загружена и есть попытки
                if (attempts < maxAttempts) {
                    // Подождать и проверить снова
                    setTimeout(checkRegister, 500);
                } else {
                    // Превышено количество попыток
                    callback(false);
                }
            }
            
                checkRegister();
            }
            
            // Функция попытки регистрации
            function tryRegister(name, email, password, phone) {
            if (typeof register === 'undefined' && typeof window.register !== 'undefined') {
                // Использовать window.register
                return window.register(name, email, password, phone);
            } else if (typeof register !== 'undefined') {
                return register(name, email, password, phone);
            } else {
                    return Promise.resolve(null);
                }
            }
            
            // Обработка формы регистрации
            var registerForm = document.getElementById('register-form');
            var registerError = document.getElementById('register-error');
            if (!registerForm || !registerError) {
                // Элементы еще не загружены, попробовать позже
                setTimeout(initForms, 100);
                return;
            }
            var registerBtn = registerForm.querySelector('.login-btn');
            var originalRegisterBtnText = registerBtn.textContent;
        
        registerForm.addEventListener('submit', function(event) {
            event.preventDefault();
            
            var name = document.getElementById('register-name').value.trim();
            var email = document.getElementById('register-email').value.trim();
            var phone = document.getElementById('register-phone').value.trim();
            var password = document.getElementById('register-password').value;
            var passwordConfirm = document.getElementById('register-password-confirm').value;
            
            // Валидация
            registerError.textContent = '';
            registerError.style.display = 'none';
            
            if (!name || !email || !password) {
                registerError.textContent = 'Iltimos, barcha maydonlarni to\'ldiring';
                registerError.style.display = 'block';
                return;
            }
            
            if (password.length < 6) {
                registerError.textContent = 'Parol kamida 6 belgidan iborat bo\'lishi kerak';
                registerError.style.display = 'block';
                return;
            }
            
            if (password !== passwordConfirm) {
                registerError.textContent = 'Parollar mos kelmaydi';
                registerError.style.display = 'block';
                return;
            }
            
            // Показать индикатор загрузки
            registerBtn.disabled = true;
            registerBtn.textContent = 'Yuklanmoqda...';
            
            // Проверить, загружена ли функция register
            if (typeof register !== 'undefined' || typeof window.register !== 'undefined') {
                // Функция уже загружена, можно регистрироваться
                tryRegister(name, email, password, phone).then(function(user) {
                    if (user) {
                        // Успешная регистрация, перенаправить на главную страницу
                        if (typeof getRolePage !== 'undefined') {
                            var rolePage = getRolePage(user.role);
                            window.location.href = rolePage;
                        } else {
                            window.location.href = 'index.html';
                        }
                    } else {
                        registerError.textContent = 'Ro\'yxatdan o\'tishda xatolik yuz berdi';
                        registerError.style.display = 'block';
                        registerBtn.disabled = false;
                        registerBtn.textContent = originalRegisterBtnText;
                    }
                }).catch(function(error) {
                    console.error('Ошибка регистрации:', error);
                    var errorMessage = 'Ro\'yxatdan o\'tishda xatolik yuz berdi';
                    
                    // Более детальные сообщения об ошибках
                    if (error && error.code) {
                        switch(error.code) {
                            case 'auth/email-already-in-use':
                                errorMessage = 'Bu email allaqachon ishlatilgan';
                                break;
                            case 'auth/invalid-email':
                                errorMessage = 'Noto\'g\'ri email formati';
                                break;
                            case 'auth/weak-password':
                                errorMessage = 'Parol juda zaif. Kamida 6 belgi bo\'lishi kerak';
                                break;
                            case 'auth/network-request-failed':
                                errorMessage = 'Internet aloqasi yo\'q. Iltimos, internetni tekshiring';
                                break;
                            default:
                                errorMessage = 'Xatolik: ' + (error.message || error.code || 'Noma\'lum xatolik');
                        }
                    } else if (error && error.message) {
                        errorMessage = 'Xatolik: ' + error.message;
                    }
                    
                    registerError.textContent = errorMessage;
                    registerError.style.display = 'block';
                    registerBtn.disabled = false;
                    registerBtn.textContent = originalRegisterBtnText;
                });
            } else {
                // Ждать загрузки функции register
                waitForRegister(function(success) {
                    if (success) {
                        tryRegister(name, email, password, phone).then(function(user) {
                            if (user) {
                                // Успешная регистрация, перенаправить на главную страницу
                                if (typeof getRolePage !== 'undefined') {
                                    var rolePage = getRolePage(user.role);
                                    window.location.href = rolePage;
                                } else {
                                    window.location.href = 'index.html';
                                }
                            } else {
                                registerError.textContent = 'Ro\'yxatdan o\'tishda xatolik yuz berdi';
                                registerError.style.display = 'block';
                                registerBtn.disabled = false;
                                registerBtn.textContent = originalRegisterBtnText;
                            }
                        }).catch(function(error) {
                            console.error('Ошибка регистрации:', error);
                            var errorMessage = 'Ro\'yxatdan o\'tishda xatolik yuz berdi';
                            
                            // Более детальные сообщения об ошибках
                            if (error && error.code) {
                                switch(error.code) {
                                    case 'auth/email-already-in-use':
                                        errorMessage = 'Bu email allaqachon ishlatilgan';
                                        break;
                                    case 'auth/invalid-email':
                                        errorMessage = 'Noto\'g\'ri email formati';
                                        break;
                                    case 'auth/weak-password':
                                        errorMessage = 'Parol juda zaif. Kamida 6 belgi bo\'lishi kerak';
                                        break;
                                    case 'auth/network-request-failed':
                                        errorMessage = 'Internet aloqasi yo\'q. Iltimos, internetni tekshiring';
                                        break;
                                    default:
                                        errorMessage = 'Xatolik: ' + (error.message || error.code || 'Noma\'lum xatolik');
                                }
                            } else if (error && error.message) {
                                errorMessage = 'Xatolik: ' + error.message;
                            }
                            
                            registerError.textContent = errorMessage;
                            registerError.style.display = 'block';
                            registerBtn.disabled = false;
                            registerBtn.textContent = originalRegisterBtnText;
                        });
                    } else {
                        registerError.textContent = 'Xatolik: register funksiyasi yuklanmadi. Iltimos, sahifani yangilang.';
                        registerError.style.display = 'block';
                        registerBtn.disabled = false;
                        registerBtn.textContent = originalRegisterBtnText;
                    }
                });
            }
        });
        }
        
        // Инициализировать формы после загрузки DOM
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initForms);
        } else {
            initForms();
        }
        
        // Функции переключения между формами
        function switchToLogin() {
            document.getElementById('login-form-container').style.display = 'block';
            document.getElementById('register-form-container').style.display = 'none';
            document.getElementById('login-tab').classList.add('active');
            document.getElementById('register-tab').classList.remove('active');
        }
        
        function switchToRegister() {
            document.getElementById('login-form-container').style.display = 'none';
            document.getElementById('register-form-container').style.display = 'block';
            document.getElementById('login-tab').classList.remove('active');
            document.getElementById('register-tab').classList.add('active');
        }
        
        // Сделать функции глобальными
        window.switchToLogin = switchToLogin;
        window.switchToRegister = switchToRegister;
    </script>
</body>
</html>
