<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tizimga kirish</title>
    <link rel="stylesheet" href="styles/base.css">
    <link rel="stylesheet" href="styles/layout.css">
    <link rel="stylesheet" href="styles/components.css">
    <link rel="stylesheet" href="styles/admin.css">
</head>
<body class="login-page">
    <div class="login-container">
        <div class="login-card">
            <h1 class="login-title">Tizimga kirish</h1>
            <p class="login-subtitle">Login va parolni kiriting</p>
            
            <form class="login-form" id="login-form">
                <div class="form-group">
                    <label for="login-input" class="form-label">Login</label>
                    <input 
                        type="text" 
                        id="login-input" 
                        class="form-input" 
                        placeholder="Loginni kiriting" 
                        required
                        autocomplete="username"
                    >
                </div>

                <div class="form-group">
                    <label for="password-input" class="form-label">Parol</label>
                    <input 
                        type="password" 
                        id="password-input" 
                        class="form-input" 
                        placeholder="Parolni kiriting" 
                        required
                        autocomplete="current-password"
                    >
                </div>

                <div class="form-error" id="login-error"></div>

                <button type="submit" class="login-btn">Kirish</button>
            </form>

            <div class="login-info">
                <p class="login-info__title">Test akkauntlar:</p>
                <ul class="login-info__list">
                    <li><strong>admin</strong> / admin123 - Super-admin</li>
                    <li><strong>manager</strong> / manager123 - Menejer</li>
                    <li><strong>picker</strong> / picker123 - Yig'uvchi</li>
                    <li><strong>courier</strong> / courier123 - Kuryer</li>
                    <li><strong>user</strong> / user123 - Oddiy foydalanuvchi</li>
                </ul>
            </div>

            <div class="login-footer">
                <a href="index.html" class="login-link">← Saytga qaytish</a>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>
    
    <!-- Firebase Config -->
    <script src="js/firebase-config.js"></script>
    
    <!-- API Module -->
    <script src="js/api.js"></script>
    
    <!-- Application Scripts -->
    <script src="js/users.js"></script>
    <script src="js/roles.js"></script>
    <script>
        // Инициализация Firebase и загрузка пользователей
        (function() {
            // Проверка, продакшен или локально
            var isProduction = window.location && 
                              window.location.hostname !== 'localhost' && 
                              window.location.hostname !== '127.0.0.1';
            
            // Инициализация Firebase
            if (typeof initFirebase !== 'undefined') {
                document.addEventListener('DOMContentLoaded', function() {
                    if (initFirebase()) {
                        // В продакшене переключить на Firebase режим
                        if (isProduction && typeof setAPIMode !== 'undefined') {
                            try {
                                setAPIMode('firebase');
                                // Загрузить пользователей из Firebase
                                if (typeof loadUsersFromFirebase !== 'undefined') {
                                    setTimeout(function() {
                                        loadUsersFromFirebase();
                                    }, 500);
                                } else if (typeof initUsersStorage !== 'undefined') {
                                    setTimeout(function() {
                                        initUsersStorage();
                                    }, 500);
                                }
                            } catch (e) {
                                if (typeof logError !== 'undefined') {
                                    logError('Ошибка инициализации Firebase', e);
                                }
                            }
                        } else {
                            // Локально загрузить пользователей
                            if (typeof initUsersStorage !== 'undefined') {
                                initUsersStorage();
                            }
                        }
                    }
                });
            }
        })();
        
        // Обработка формы входа
        var loginForm = document.getElementById('login-form');
        var loginError = document.getElementById('login-error');
        var loginBtn = loginForm.querySelector('.login-btn');
        var originalBtnText = loginBtn.textContent;

        // Функция ожидания загрузки пользователей
        function waitForUsers(callback, maxAttempts) {
            maxAttempts = maxAttempts || 20; // Максимум 20 попыток (10 секунд)
            var attempts = 0;
            
            function checkUsers() {
                attempts++;
                
                // Проверить, загружены ли пользователи
                if (typeof usersStorage !== 'undefined' && usersStorage.users.length > 0) {
                    callback(true);
                    return;
                }
                
                // Если не загружены и есть попытки
                if (attempts < maxAttempts) {
                    // Попробовать загрузить пользователей
                    if (typeof loadUsersFromFirebase !== 'undefined' && typeof API_MODE !== 'undefined' && API_MODE === 'firebase') {
                        loadUsersFromFirebase();
                    } else if (typeof initUsersStorage !== 'undefined') {
                        initUsersStorage();
                    }
                    
                    // Подождать и проверить снова
                    setTimeout(checkUsers, 500);
                } else {
                    // Превышено количество попыток
                    callback(false);
                }
            }
            
            checkUsers();
        }
        
        // Функция попытки входа
        function tryLogin(loginValue, password) {
            if (typeof login === 'undefined') {
                loginError.textContent = 'Xatolik: login funksiyasi topilmadi';
                loginError.style.display = 'block';
                loginBtn.disabled = false;
                loginBtn.textContent = originalBtnText;
                return;
            }
            
            var user = login(loginValue, password);

            if (user) {
                // Получить страницу для роли пользователя
                if (typeof getRolePage !== 'undefined') {
                    var rolePage = getRolePage(user.role);
                    window.location.href = rolePage;
                } else {
                    loginError.textContent = 'Xatolik: getRolePage funksiyasi topilmadi';
                    loginError.style.display = 'block';
                    loginBtn.disabled = false;
                    loginBtn.textContent = originalBtnText;
                }
            } else {
                loginError.textContent = 'Noto\'g\'ri login yoki parol';
                loginError.style.display = 'block';
                loginBtn.disabled = false;
                loginBtn.textContent = originalBtnText;
            }
        }

        loginForm.addEventListener('submit', function(event) {
            event.preventDefault();

            var loginValue = document.getElementById('login-input').value.trim();
            var password = document.getElementById('password-input').value;

            // Валидация
            if (!loginValue || !password) {
                loginError.textContent = 'Iltimos, login va parolni kiriting';
                loginError.style.display = 'block';
                return;
            }

            loginError.textContent = '';
            loginError.style.display = 'none';
            
            // Показать индикатор загрузки
            loginBtn.disabled = true;
            loginBtn.textContent = 'Yuklanmoqda...';

            // Проверить, загружены ли пользователи
            if (typeof usersStorage !== 'undefined' && usersStorage.users.length > 0) {
                // Пользователи уже загружены, можно входить
                tryLogin(loginValue, password);
            } else {
                // Ждать загрузки пользователей
                waitForUsers(function(success) {
                    if (success) {
                        tryLogin(loginValue, password);
                    } else {
                        loginError.textContent = 'Xatolik: foydalanuvchilar yuklanmadi. Iltimos, sahifani yangilang.';
                        loginError.style.display = 'block';
                        loginBtn.disabled = false;
                        loginBtn.textContent = originalBtnText;
                    }
                });
            }
        });
    </script>
</body>
</html>
